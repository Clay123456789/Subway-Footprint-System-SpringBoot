# 一.后端项目信息

后端项目github[网址](https://github.com/Clay123456789/Subway-Footprint-System-SpringBoot)

服务器ip:123.56.150.89

端口号：8088

域名：thelittlestar.cn(解析即为123.56.150.89:8088)

# 二.数据库选择方案：

使用mysql作为主要的数据库，针对部分修改频率较低而访问频率较高的数据，如地铁图信息，采用Mysql和redis配合使用方案，使用redis做缓存，将用户访问频繁的数据放在缓存中，以提高响应速度。

在接受前端发来的访问请求时，进行以下操作：

* 查询：

  前端发来请求时，先从缓存redis中进行查询，如果缓存存在要查询的数据，则返回。否则去mysql数据库中查询，成功查询数据后添加其到缓存中并设定有效时间，再返回数据，这样在一定时间内再次查询该数据时，便可直接从缓存中取，提高查询效率。

* 增加：

  直接添加到mysql数据库,将缓存中数据所在表删除（为了保证selectAll获取数据一致）。

* 删除：

  先删除mysql数据库，再将缓存的数据删除即可。

* 修改：

  先修改mysql数据库，再将缓存的数据删除即可，不直接更新缓存，效率太低。

# 三.mysql数据库设计

## 数据库设计视图

![数据库设计](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1.jpg)

## 1.地铁——subway

![image-20211216004901468](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20211216004901468.png)

该表主要存储从百度api（http://map.baidu.com/和https://api.map.baidu.com/）获取并解析出的地铁数据，作为项目绘制地铁图的数据来源。

* 其中，属性l_xmlatter存储json字段结构如下：![image-20211216005342262](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20211216005342262.png)

  其中，lid为路线id，lb为别名，lbx和lby为绘制时文字的偏移量，uid是可辨识的唯一属性。

* 属性p存储json字段结构如下：

  ![image-20211216010511444](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20211216010511444.png)

  其中，每个p_xmlattar表示一个站点信息，sid为站点id,lb为站名，x和y为站点坐标，rx和ry为绘制时文字偏移量，st表示是否为站点，ex表示是否为中转站，ln为所在线路，uid是可辨识的唯一属性。

## 2.普通用户——user

![image-20220418015429613](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20220418015429613.png)

## 3.商户——merchant

![image-20220418014744876](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20220418014744876.png)

## 4.点亮站点——lightedstation

![image-20220418015526314](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20220418015526314.png)

## 5.管理员——manager

![image-20220418015643693](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20220418015643693.png)

## 6.宝藏——treasure

![image-20220418015815445](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20220418015815445.png)

## 7.奖品——award

![image-20220418015937504](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20220418015937504.png)

## 8.奖品流水记录——await_record

![image-20220418020035220](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20220418020035220.png)

## 9.碳积分流水记录——credit_record

![image-20220418020140467](https://cdn.jsdelivr.net/gh/Clay123456789/picture_bed/img/image-20220418020140467.png)

# 四.接口api

```
url=http://ip:8888/xxx

1
/*
* 请求方式：get
* 功能：获取指定/所有城市铁路信息
* 路径 /Subway/getAllSubways
* 传参(json) code(0代表所有)
* 返回值(json) String（用Result封装json中会有转义符干扰，故此接口直接返回结果）
* */
2
/*
* 请求方式：get
* 功能：上传所有城市铁路信息
* 路径 /Subway/uploadAllSubways
* 传参(json) null
* 返回值(json--Result) code,message,data(boolean)
* */
3
/*
* 请求方式：post
* 功能：登陆
* 路径 /user/login
* 传参(json) username,password
* 返回值(json--Result) code,message,data(str)
* */
4
/*
* 请求方式：post
* 功能：发送注册邮件
* 路径 /user/sendRegistEmail
* 传参(json) email
* 返回值(json--Result) code,message,data(str)
* */
5
/*
* 请求方式：post
* 功能：注册新用户
* 路径 /user/regist
* 传参(json) username,password,email,code
* 返回值(json--Result) code,message,data(str)
* */ 
6
/*
* 请求方式：post
* 功能：找回密码
* 路径 /user/findPassword
* 传参(json) email
* 返回值(json--Result) code,message,data(str)
* */
7
/*
* 请求方式：post
* 功能：修改用户密码
* 路径 /user/changePassword
* 传参(json) email,Password,newPassword
* 返回值(json--Result) code,message,data(Str)
* */
8
/*
* 请求方式：post
* 功能：获取用户信息
* 路径 /user/getUser
* 传参(json):null
* 返回值(json--Result) code,message,data(User)一个完整的User类实例
* */
9
/*
* 请求方式：post
* 功能：修改用户信息（不包含修改用户uid、密码、和邮箱）
* 路径 /user/updateUser
* 传参(json) （修改后的的User各属性）username,age,sex,tel,touxiang,qianming,credit
* 返回值 (json--Result) code,message,data(str)
* */
10
/*
* 请求方式：post
* 功能：用户新增点亮站点(成功后自动触发增加碳积分)
* 路径 /user/addLightedStation
* 传参(json) pid(站点id) credit(点亮获得碳积分)
* 返回值 (json--Result) code,message,data(str)
* */
11
/*
* 请求方式：post
* 功能：用户删除点亮站点
* 路径 /user/deleteLightedStation
* 传参(json) pid(站点id)
* 返回值 (json--Result) code,message,data(str)
* */
12
/*
* 请求方式：post
* 功能：用户修改点亮站点获得的碳积分
* 路径 /user/updateLightedStation
* 传参(json) pid(站点id) credit(积分)
* 返回值 (json--Result) code,message,data(str)
* */
13
/*
* 请求方式：post
* 功能：用户获取指定点亮站点信息
* 路径 /user/getLightedStation
* 传参(json) pid(站点id)
* 返回值 (json--Result) code,message,data(LightedStation)
* */
14
/*
* 请求方式：post
* 功能：用户获取个人全部点亮站点信息
* 路径 /user/getUserLightedStations
* 传参(json) null
* 返回值 (json--Result) code,message,data(List<LightedStation>)
* */
15
/*
* 请求方式：post
* 功能：获取碳积分排行榜（前10位）
* 路径 /user/getRankingList
* 传参(json) null
* 返回值 (json--Result) code,message,data(List<map>)
*  map有rank、touxiang、username、credit四个key值
* */
16
/*
* 请求方式：post
* 功能：获取碳积分历史
* 路径 /user/getUserCreditRecords
* 传参(json) null
* 返回值 (json--Result) code,message,data(List<CreditRecord>)
* */
17
/*
* 请求方式：post
* 功能：新增一条碳积分记录（点亮站点获得碳积分会自动调用该接口，注意不要重复调用）
* 路径 /user/addCreditRecord
* 传参(json) operation,way,num
* 返回值 (json--Result) code,message,data(str)
* */
18
 /*
 * 请求方式：post
 * 功能：用户/商户藏宝
 * 路径 /treasure/buryTreasure
 * 传参(json) variety(宝箱种类) content(宝箱内容) credit(打开所需碳积分) pid(站点id)
 * 返回值 (json--Result) code,message,data(str)
 * */
 19
 /*
 * 请求方式：post
 * 功能：用户挖宝
 * 路径 /treasure/digTreasure
 * 传参(json) tid(宝箱id)
 * 返回值 (json--Result) code,message,data(str)
 * */
 20
 /*
 * 请求方式：post
 * 功能：用户打开宝箱
 * 路径 /treasure/openTreasure
 * 传参(json) tid(宝箱id)
 * 返回值 (json--Result) code,message,data(str)
 * */
 21
 /*
 * 请求方式：post
 * 功能：查询单个宝箱
 * 路径 /treasure/getTreasure
 * 传参(json) tid(宝箱id)
 * 返回值 (json--Result) code,message,data(str)
 * */
 22
 /*
 * 请求方式：post
 * 功能：查询某一站点的所有未挖宝箱
 * 路径 /treasure/getPositionTreasure
 * 传参(json) pid(站点id)
 * 返回值 (json--Result) code,message,data(str)
 * */
 23
 /*
 * 请求方式：post
 * 功能：查询所有未挖宝箱
 * 路径 /treasure/getAllTreasure
 * 传参(json) null
 * 返回值 (json--Result) code,message,data(str)
 * */
 24
  /*
  * 请求方式：post
  * 功能：获取属于某一用户的所有未打开宝箱
  * 路径 /treasure/getUserTreasure
  * 传参(json) null
  * 返回值 (json--Result) code,message,data(str)
  * */

```

